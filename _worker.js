import{connect}from"cloudflare:sockets";let fakeUserID,fakeHostName,password="",proxyIP="",sub="",subConverter="SUBAPI.fxxk.dedyn.io",subConfig="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_MultiMode.ini",subProtocol="https",subEmoji="true",socks5Address="",parsedSocks5Address={},enableSocks=!1;const expire=4102329600;let proxyIPs,socks5s,sha224Password,go2Socks5s=["*ttvnw.net","*tapecontent.net","*cloudatacdn.com","*.loadshare.org"],addresses=[],addressesapi=[],addressescsv=[],DLS=8,remarkIndex=1,FileName="epeius",BotToken="",ChatID="",proxyhosts=[],proxyhostsURL="",RproxyIP="false",httpsPorts=["2053","2083","2087","2096","8443"];const regex=/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\[.*\]):?(\d+)?#?(.*)?$/;let proxyIPPool=[],path="/?ed=2560";export default{async fetch(e,s,t){try{const t=e.headers.get("User-Agent")||"null",r=t.toLowerCase();if(password=s.PASSWORD||password,!password)return new Response("请设置你的PASSWORD变量，或尝试重试部署，检查变量是否生效？",{status:404,headers:{"Content-Type":"text/plain;charset=utf-8"}});sha224Password=s.SHA224||s.SHA224PASS||sha224(password),subEmoji=s.SUBEMOJI||s.EMOJI||subEmoji,"0"==subEmoji&&(subEmoji="false");const o=new Date;o.setHours(0,0,0,0);const n=Math.ceil(o.getTime()/1e3),a=await MD5MD5(`${password}${n}`);if(fakeUserID=[a.slice(0,8),a.slice(8,12),a.slice(12,16),a.slice(16,20),a.slice(20)].join("-"),fakeHostName=`${a.slice(6,9)}.${a.slice(13,19)}`,proxyIP=s.PROXYIP||proxyIP,proxyIPs=await ADD(proxyIP),proxyIP=proxyIPs[Math.floor(Math.random()*proxyIPs.length)],socks5Address=s.SOCKS5||socks5Address,socks5s=await ADD(socks5Address),socks5Address=socks5s[Math.floor(Math.random()*socks5s.length)],socks5Address=socks5Address.split("//")[1]||socks5Address,s.CFPORTS&&(httpsPorts=await ADD(s.CFPORTS)),sub=s.SUB||sub,subConverter=s.SUBAPI||subConverter,subConverter.includes("http://")?(subConverter=subConverter.split("//")[1],subProtocol="http"):subConverter=subConverter.split("//")[1]||subConverter,subConfig=s.SUBCONFIG||subConfig,socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),RproxyIP=s.RPROXYIP||"false",enableSocks=!0}catch(e){let t=e;console.log(t.toString()),RproxyIP=s.RPROXYIP||!proxyIP?"true":"false",enableSocks=!1}else RproxyIP=s.RPROXYIP||!proxyIP?"true":"false";s.ADD&&(addresses=await ADD(s.ADD)),s.ADDAPI&&(addressesapi=await ADD(s.ADDAPI)),s.ADDCSV&&(addressescsv=await ADD(s.ADDCSV)),DLS=s.DLS||DLS,remarkIndex=s.CSVREMARK||remarkIndex,BotToken=s.TGTOKEN||BotToken,ChatID=s.TGID||ChatID,s.GO2SOCKS5&&(go2Socks5s=await ADD(s.GO2SOCKS5));const c=e.headers.get("Upgrade"),i=new URL(e.url);if(i.searchParams.has("sub")&&""!==i.searchParams.get("sub")&&(sub=i.searchParams.get("sub")),FileName=s.SUBNAME||FileName,c&&"websocket"===c){if(socks5Address=i.searchParams.get("socks5")||socks5Address,new RegExp("/socks5=","i").test(i.pathname))socks5Address=i.pathname.split("5=")[1];else if((new RegExp("/socks://","i").test(i.pathname)||new RegExp("/socks5://","i").test(i.pathname))&&(socks5Address=i.pathname.split("://")[1].split("#")[0],socks5Address.includes("@"))){let e=socks5Address.split("@")[0];/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=)?$/i.test(e)&&!e.includes(":")&&(e=atob(e)),socks5Address=`${e}@${socks5Address.split("@")[1]}`}if(socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),enableSocks=!0}catch(e){let s=e;console.log(s.toString()),enableSocks=!1}else enableSocks=!1;return i.searchParams.has("proxyip")?(proxyIP=i.searchParams.get("proxyip"),enableSocks=!1):new RegExp("/proxyip=","i").test(i.pathname)?(proxyIP=i.pathname.toLowerCase().split("/proxyip=")[1],enableSocks=!1):new RegExp("/proxyip.","i").test(i.pathname)&&(proxyIP=`proxyip.${i.pathname.toLowerCase().split("/proxyip.")[1]}`,enableSocks=!1),await 特洛伊OverWSHandler(e)}switch(i.searchParams.has("proxyip")?(path=`/?ed=2560&proxyip=${i.searchParams.get("proxyip")}`,RproxyIP="false"):i.searchParams.has("socks5")?(path=`/?ed=2560&socks5=${i.searchParams.get("socks5")}`,RproxyIP="false"):i.searchParams.has("socks")&&(path=`/?ed=2560&socks5=${i.searchParams.get("socks")}`,RproxyIP="false"),i.pathname){case"/":return s.URL302?Response.redirect(s.URL302,302):s.URL?await proxyURL(s.URL,i):new Response(JSON.stringify(e.cf,null,4),{status:200,headers:{"content-type":"application/json"}});case`/${fakeUserID}`:const o=await get特洛伊Config(password,e.headers.get("Host"),sub,"CF-Workers-SUB",RproxyIP,i);return new Response(`${o}`,{status:200});case`/${password}`:await sendMessage(`#获取订阅 ${FileName}`,e.headers.get("CF-Connecting-IP"),`UA: ${t}</tg-spoiler>\n域名: ${i.hostname}\n<tg-spoiler>入口: ${i.pathname+i.search}</tg-spoiler>`);const n=await get特洛伊Config(password,e.headers.get("Host"),sub,t,RproxyIP,i),a=Date.now(),c=new Date(a);c.setHours(0,0,0,0);const l=Math.floor((a-c.getTime())/864e5*24*1099511627776/2);let d=l,p=l,u=26388279066624;return r&&(r.includes("mozilla")||r.includes("subconverter"))?new Response(`${n}`,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${d}; download=${p}; total=${u}; expire=${expire}`}}):new Response(`${n}`,{status:200,headers:{"Content-Disposition":`attachment; filename=${FileName}; filename*=utf-8''${encodeURIComponent(FileName)}`,"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${d}; download=${p}; total=${u}; expire=${expire}`}});default:return s.URL302?Response.redirect(s.URL302,302):s.URL?await proxyURL(s.URL,i):new Response("不用怀疑！你PASSWORD就是错的！！！",{status:404})}}catch(e){return new Response(e.toString())}}};async function 特洛伊OverWSHandler(e){const s=new WebSocketPair,[t,r]=Object.values(s);r.accept();let o="",n="";const log=(e,s)=>{console.log(`[${o}:${n}] ${e}`,s||"")},a=e.headers.get("sec-websocket-protocol")||"",c=makeReadableWebSocketStream(r,a,log);let i={value:null};return c.pipeTo(new WritableStream({async write(e,s){if(i.value){const s=i.value.writable.getWriter();return await s.write(e),void s.releaseLock()}const{hasError:t,message:a,portRemote:c=443,addressRemote:l="",rawClientData:d,addressType:p}=await parse特洛伊Header(e);if(o=l,n=`${c}--${Math.random()} tcp`,t)throw new Error(a);handleTCPOutBound(i,l,c,d,r,log,p)},close(){log("readableWebSocketStream is closed")},abort(e){log("readableWebSocketStream is aborted",JSON.stringify(e))}})).catch((e=>{log("readableWebSocketStream pipeTo error",e)})),new Response(null,{status:101,webSocket:t})}async function parse特洛伊Header(e){if(e.byteLength<56)return{hasError:!0,message:"invalid data"};if(13!==new Uint8Array(e.slice(56,57))[0]||10!==new Uint8Array(e.slice(57,58))[0])return{hasError:!0,message:"invalid header format (missing CR LF)"};if((new TextDecoder).decode(e.slice(0,56))!==sha224Password)return{hasError:!0,message:"invalid password"};const s=e.slice(58);if(s.byteLength<6)return{hasError:!0,message:"invalid SOCKS5 request data"};const t=new DataView(s);if(1!==t.getUint8(0))return{hasError:!0,message:"unsupported command, only TCP (CONNECT) is allowed"};const r=t.getUint8(1);let o=0,n=2,a="";switch(r){case 1:o=4,a=new Uint8Array(s.slice(n,n+o)).join(".");break;case 3:o=new Uint8Array(s.slice(n,n+1))[0],n+=1,a=(new TextDecoder).decode(s.slice(n,n+o));break;case 4:o=16;const e=new DataView(s.slice(n,n+o)),t=[];for(let s=0;s<8;s++)t.push(e.getUint16(2*s).toString(16));a=t.join(":");break;default:return{hasError:!0,message:`invalid addressType is ${r}`}}if(!a)return{hasError:!0,message:`address is empty, addressType is ${r}`};const c=n+o,i=s.slice(c,c+2);return{hasError:!1,addressRemote:a,portRemote:new DataView(i).getUint16(0),rawClientData:s.slice(c+4),addressType:r}}async function handleTCPOutBound(e,s,t,r,o,n,a){async function connectAndWrite(s,t,o=!1){n(`connected to ${s}:${t}`);const c=o?await socks5Connect(a,s,t,n):connect({hostname:s,port:t});e.value=c;const i=c.writable.getWriter();return await i.write(r),i.releaseLock(),c}let c=!1;go2Socks5s.length>0&&enableSocks&&(c=await async function(e){return!(!go2Socks5s.includes(atob("YWxsIGlu"))&&!go2Socks5s.includes(atob("Kg==")))||go2Socks5s.some((s=>{let t=s.replace(/\*/g,".*");return new RegExp(`^${t}$`,"i").test(e)}))}(s));let i=await connectAndWrite(s,t,c);remoteSocketToWS(i,o,(async function(){enableSocks?i=await connectAndWrite(s,t,!0):(proxyIP&&""!=proxyIP?proxyIP.includes("]:")?(t=proxyIP.split("]:")[1]||t,proxyIP=proxyIP.split("]:")[0]||proxyIP):2===proxyIP.split(":").length&&(t=proxyIP.split(":")[1]||t,proxyIP=proxyIP.split(":")[0]||proxyIP):proxyIP=atob("UFJPWFlJUC50cDEuZnh4ay5kZWR5bi5pbw=="),proxyIP.includes(".tp")&&(t=proxyIP.split(".tp")[1].split(".")[0]||t),i=await connectAndWrite(proxyIP||s,t)),i.closed.catch((e=>{console.log("retry tcpSocket closed error",e)})).finally((()=>{safeCloseWebSocket(o)})),remoteSocketToWS(i,o,null,n)}),n)}function makeReadableWebSocketStream(e,s,t){let r=!1;return new ReadableStream({start(o){e.addEventListener("message",(e=>{if(r)return;const s=e.data;o.enqueue(s)})),e.addEventListener("close",(()=>{safeCloseWebSocket(e),r||o.close()})),e.addEventListener("error",(e=>{t("webSocketServer error"),o.error(e)}));const{earlyData:n,error:a}=base64ToArrayBuffer(s);a?o.error(a):n&&o.enqueue(n)},pull(e){},cancel(s){r||(t(`readableStream was canceled, due to ${s}`),r=!0,safeCloseWebSocket(e))}})}async function remoteSocketToWS(e,s,t,r){let o=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(e,t){o=!0,s.readyState!==WS_READY_STATE_OPEN&&t.error("webSocket connection is not open"),s.send(e)},close(){r(`remoteSocket.readable is closed, hasIncomingData: ${o}`)},abort(e){console.error("remoteSocket.readable abort",e)}})).catch((e=>{console.error("remoteSocketToWS error:",e.stack||e),safeCloseWebSocket(s)})),!1===o&&t&&(r("retry"),t())}function base64ToArrayBuffer(e){if(!e)return{error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");const s=atob(e);return{earlyData:Uint8Array.from(s,(e=>e.charCodeAt(0))).buffer,error:null}}catch(e){return{error:e}}}let WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(e){try{e.readyState!==WS_READY_STATE_OPEN&&e.readyState!==WS_READY_STATE_CLOSING||e.close()}catch(e){console.error("safeCloseWebSocket error",e)}}function revertFakeInfo(e,s,t,r){return r&&(e=atob(e)),e=e.replace(new RegExp(fakeUserID,"g"),s).replace(new RegExp(fakeHostName,"g"),t),r&&(e=btoa(e)),e}async function MD5MD5(e){const s=new TextEncoder,t=await crypto.subtle.digest("MD5",s.encode(e)),r=Array.from(new Uint8Array(t)).map((e=>e.toString(16).padStart(2,"0"))).join(""),o=await crypto.subtle.digest("MD5",s.encode(r.slice(7,27)));return Array.from(new Uint8Array(o)).map((e=>e.toString(16).padStart(2,"0"))).join("").toLowerCase()}async function ADD(e){var s=e.replace(/[	|"'\r\n]+/g,",").replace(/,+/g,",");","==s.charAt(0)&&(s=s.slice(1)),","==s.charAt(s.length-1)&&(s=s.slice(0,s.length-1));return s.split(",")}async function proxyURL(e,s){const t=await ADD(e),r=t[Math.floor(Math.random()*t.length)];let o=new URL(r);console.log(o);let n=o.protocol.slice(0,-1)||"https",a=o.hostname,c=o.pathname,i=o.search;"/"==c.charAt(c.length-1)&&(c=c.slice(0,-1)),c+=s.pathname;let l=`${n}://${a}${c}${i}`,d=await fetch(l),p=new Response(d.body,{status:d.status,statusText:d.statusText,headers:d.headers});return p.headers.set("X-New-URL",l),p}function 配置信息(e,s){const t=atob("dHJvamFu"),r=FileName;let o=s;const n=s,a=path;const c=s,i="randomized";return[`${t}://${encodeURIComponent(e)}@${o}:443?security=tls&sni=${c}&alpn=h3&fp=${i}&allowInsecure=1&type=ws&host=${n}&path=${encodeURIComponent(a)}#${encodeURIComponent(r)}`,`- {name: ${r}, server: ${o}, port: 443, udp: false, client-fingerprint: ${i}, type: ${t}, password: ${e}, sni: ${c}, alpn: [h3], skip-cert-verify: true, network: ws, ws-opts: {path: "${a}", headers: {Host: ${n}}}}`]}let subParams=["sub","base64","b64","clash","singbox","sb","surge"];async function get特洛伊Config(e,s,t,r,o,n){if(t){const e=t.match(/^(?:https?:\/\/)?([^\/]+)/);e&&(t=e[1]);const s=await ADD(t);s.length>1&&(t=s[0])}else if(addresses.length+addressesapi.length+addressescsv.length==0){let e=["103.21.244.0/23","104.16.0.0/13","104.24.0.0/14","172.64.0.0/14","103.21.244.0/23","104.16.0.0/14","104.24.0.0/15","141.101.64.0/19","172.64.0.0/14","188.114.96.0/21","190.93.240.0/21"];addresses=addresses.concat("127.0.0.1:1234#CFnat"),addresses=addresses.concat(e.map((e=>function(e){const[s,t]=e.split("/"),r=s.split(".").map(Number),o=32-parseInt(t,10),n=Math.pow(2,o)-1,a=Math.floor(Math.random()*n);return r.map(((e,s)=>s<2?e:2===s?(e&255<<o-8)+(a>>8&255):(e&255<<o)+(255&a))).join(".")}(e)+"#CF随机节点")))}const a=r.toLowerCase(),c=配置信息(e,s),i=c[0],l=c[1];let d="";if(s.includes(".workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{const e=await fetch(proxyhostsURL);if(!e.ok)return void console.error("获取地址时出错:",e.status,e.statusText);const s=await e.text(),t=s.split("\n").filter((e=>""!==e.trim()));proxyhosts=proxyhosts.concat(t)}catch(e){}0!=proxyhosts.length&&(d=proxyhosts[Math.floor(Math.random()*proxyhosts.length)]+"/")}if(a.includes("mozilla")&&!subParams.some((e=>n.searchParams.has(e)))){let n=`Surge订阅地址:\nhttps://${d}${s}/${e}?surge`;s.includes(".workers.dev")&&(n="Surge订阅必须绑定自定义域");const a=socks5s.map((e=>e.includes("@")?e.split("@")[1]:e.includes("//")?e.split("//")[1]:e));let c="";go2Socks5s.length>0&&enableSocks&&(c=`${decodeURIComponent("SOCKS5%EF%BC%88%E7%99%BD%E5%90%8D%E5%8D%95%EF%BC%89%3A%20")}`,go2Socks5s.includes(atob("YWxsIGlu"))||go2Socks5s.includes(atob("Kg=="))?c+=`${decodeURIComponent("%E6%89%80%E6%9C%89%E6%B5%81%E9%87%8F")}\n`:c+=`\n  ${go2Socks5s.join("\n  ")}\n`);let p="";return t?(p+=enableSocks?`CFCDN（访问方式）: Socks5\n  ${a.join("\n  ")}\n${c}`:proxyIP&&""!=proxyIP?`CFCDN（访问方式）: ProxyIP\n  ${proxyIPs.join("\n  ")}\n`:"true"==o?"CFCDN（访问方式）: 自动获取ProxyIP\n":"CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！\n",p+=`\nSUB（优选订阅生成器）: ${t}`):(p+=enableSocks?`CFCDN（访问方式）: Socks5\n  ${a.join("\n  ")}\n${c}`:proxyIP&&""!=proxyIP?`CFCDN（访问方式）: ProxyIP\n  ${proxyIPs.join("\n  ")}\n`:"CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！\n",p+="\n您的订阅内容由 内置 addresses/ADD* 参数变量提供\n",addresses.length>0&&(p+=`ADD（TLS优选域名&IP）: \n  ${addresses.join("\n  ")}\n`),addressesapi.length>0&&(p+=`ADDAPI（TLS优选域名&IP 的 API）: \n  ${addressesapi.join("\n  ")}\n`),addressescsv.length>0&&(p+=`ADDCSV（IPTest测速csv文件 限速 ${DLS} ）: \n  ${addressescsv.join("\n  ")}\n`)),`\n################################################################\nSubscribe / sub 订阅地址, 支持 Base64、clash-meta、sing-box 订阅格式\n---------------------------------------------------------------\n快速自适应订阅地址:\nhttps://${d}${s}/${e}\nhttps://${d}${s}/${e}?sub\n\nBase64订阅地址:\nhttps://${d}${s}/${e}?b64\nhttps://${d}${s}/${e}?base64\n\nclash订阅地址:\nhttps://${d}${s}/${e}?clash\n\nsingbox订阅地址:\nhttps://${d}${s}/${e}?sb\nhttps://${d}${s}/${e}?singbox\n\n${n}\n---------------------------------------------------------------\n################################################################\n${FileName} 配置信息\n---------------------------------------------------------------\nHOST: ${s}\nPASSWORD: ${e}\nSHA224: ${sha224Password}\nFAKEPASS: ${fakeUserID}\nUA: ${r}\n\n${p}\nSUBAPI（订阅转换后端）: ${subProtocol}://${subConverter}\nSUBCONFIG（订阅转换配置文件）: ${subConfig}\n---------------------------------------------------------------\n################################################################\nv2ray\n---------------------------------------------------------------\n${i}\n---------------------------------------------------------------\n################################################################\nclash-meta\n---------------------------------------------------------------\n${l}\n---------------------------------------------------------------\n################################################################\n${decodeURIComponent(atob("dGVsZWdyYW0lMjAlRTQlQkElQTQlRTYlQjUlODElRTclQkUlQTQlMjAlRTYlOEElODAlRTYlOUMlQUYlRTUlQTQlQTclRTQlQkQlQUMlN0UlRTUlOUMlQTglRTclQkElQkYlRTUlOEYlOTElRTclODklOEMhCmh0dHBzJTNBJTJGJTJGdC5tZSUyRkNNTGl1c3NzcwotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KZ2l0aHViJTIwJUU5JUExJUI5JUU3JTlCJUFFJUU1JTlDJUIwJUU1JTlEJTgwJTIwU3RhciFTdGFyIVN0YXIhISEKaHR0cHMlM0ElMkYlMkZnaXRodWIuY29tJTJGY21saXUlMkZlcGVpdXMKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMyUyMw=="))}\n`}{if("function"!=typeof fetch)return"Error: fetch is not available in this environment.";fakeHostName=s.includes(".workers.dev")?`${fakeHostName}.workers.dev`:`${fakeHostName}.xyz`;let r=`https://${t}/sub?host=${fakeHostName}&pw=${fakeUserID}&password=${fakeUserID+atob("JmVwZWl1cz1jbWxpdSZwcm94eWlwPQ==")+o}&path=${encodeURIComponent(path)}`,c=!0,i=[],l=[];if(!t||""==t){if(s.includes("workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{const e=await fetch(proxyhostsURL);if(!e.ok)return void console.error("获取地址时出错:",e.status,e.statusText);const s=await e.text(),t=s.split("\n").filter((e=>""!==e.trim()));proxyhosts=proxyhosts.concat(t)}catch(e){console.error("获取地址时出错:",e)}proxyhosts=[...new Set(proxyhosts)]}i=await getAddressesapi(addressesapi),l=await getAddressescsv("TRUE"),r=`https://${s}/${fakeUserID+n.search}`}a.includes("CF-Workers-SUB".toLowerCase())||(a.includes("clash")&&!a.includes("nekobox")||n.searchParams.has("clash")?(r=`${subProtocol}://${subConverter}/sub?target=clash&url=${encodeURIComponent(r)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,c=!1):a.includes("sing-box")||a.includes("singbox")||n.searchParams.has("singbox")||n.searchParams.has("sb")?(r=`${subProtocol}://${subConverter}/sub?target=singbox&url=${encodeURIComponent(r)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,c=!1):(a.includes("surge")||n.searchParams.has("surge"))&&(r=`${subProtocol}://${subConverter}/sub?target=surge&ver=4&url=${encodeURIComponent(r)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&xudp=false&udp=false&tfo=false&expand=true&scv=true&fdn=false`,c=!1));try{let o;if(t&&""!=t||1!=c){const e=await fetch(r,{headers:{"User-Agent":atob("Q0YtV29ya2Vycy1lcGVpdXMvY21saXU=")}});o=await e.text()}else o=await subAddresses(fakeHostName,fakeUserID,a,i,l);return n.pathname==`/${fakeUserID}`||(o=revertFakeInfo(o,e,s,c),(a.includes("surge")||n.searchParams.has("surge"))&&(o=surge(o,`https://${s}/${e}?surge`))),o}catch(e){return console.error("Error fetching content:",e),`Error fetching content: ${e.message}`}}}async function sendMessage(e,s,t=""){if(""!==BotToken&&""!==ChatID){let r="";const o=await fetch(`http://ip-api.com/json/${s}?lang=zh-CN`);if(200==o.status){const n=await o.json();r=`${e}\nIP: ${s}\n国家: ${n.country}\n<tg-spoiler>城市: ${n.city}\n组织: ${n.org}\nASN: ${n.as}\n${t}`}else r=`${e}\nIP: ${s}\n<tg-spoiler>${t}`;let n="https://api.telegram.org/bot"+BotToken+"/sendMessage?chat_id="+ChatID+"&parse_mode=HTML&text="+encodeURIComponent(r);return fetch(n,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","Accept-Encoding":"gzip, deflate, br","User-Agent":"Mozilla/5.0 Chrome/90.0.4430.72"}})}}async function socks5Connect(e,s,t,r){const{username:o,password:n,hostname:a,port:c}=parsedSocks5Address,i=connect({hostname:a,port:c}),l=new Uint8Array([5,2,0,2]),d=i.writable.getWriter();await d.write(l),r("sent socks greeting");const p=i.readable.getReader(),u=new TextEncoder;let y,h=(await p.read()).value;if(5!==h[0])return void r(`socks server version error: ${h[0]} expected: 5`);if(255===h[1])return void r("no acceptable methods");if(2===h[1]){if(r("socks server needs auth"),!o||!n)return void r("please provide username/password");const e=new Uint8Array([1,o.length,...u.encode(o),n.length,...u.encode(n)]);if(await d.write(e),h=(await p.read()).value,1!==h[0]||0!==h[1])return void r("fail to auth socks server")}switch(e){case 1:y=new Uint8Array([1,...s.split(".").map(Number)]);break;case 3:y=new Uint8Array([3,s.length,...u.encode(s)]);break;case 4:y=new Uint8Array([4,...s.split(":").flatMap((e=>[parseInt(e.slice(0,2),16),parseInt(e.slice(2),16)]))]);break;default:return void r(`invild  addressType is ${e}`)}const f=new Uint8Array([5,1,0,...y,t>>8,255&t]);if(await d.write(f),r("sent socks request"),h=(await p.read()).value,0===h[1])return r("socks connection opened"),d.releaseLock(),p.releaseLock(),i;r("fail to open socks connection")}function socks5AddressParser(e){let s,t,r,o,[n,a]=e.split("@").reverse();if(a){const e=a.split(":");if(2!==e.length)throw new Error("Invalid SOCKS address format");[s,t]=e}const c=n.split(":");if(o=Number(c.pop()),isNaN(o))throw new Error("Invalid SOCKS address format");r=c.join(":");if(r.includes(":")&&!/^\[.*\]$/.test(r))throw new Error("Invalid SOCKS address format");return{username:s,password:t,hostname:r,port:o}}function isValidIPv4(e){return/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e)}function subAddresses(e,s,t,r,o){addresses=addresses.concat(r),addresses=addresses.concat(o);const n=[...new Set(addresses)].map((r=>{let o="-1",n=r;const a=n.match(regex);if(a)r=a[1],o=a[2]||o,n=a[3]||r;else{if(r.includes(":")&&r.includes("#")){const e=r.split(":");r=e[0];const s=e[1].split("#");o=s[0],n=s[1]}else if(r.includes(":")){const e=r.split(":");r=e[0],o=e[1]}else if(r.includes("#")){const e=r.split("#");r=e[0],n=e[1]}n.includes(":")&&(n=n.split(":")[0])}const c=["2053","2083","2087","2096","8443"];if(!isValidIPv4(r)&&"-1"==o)for(let e of c)if(r.includes(e)){o=e;break}"-1"==o&&(o="443");let i=e,l=path,d="";proxyhosts.length>0&&i.includes(".workers.dev")&&(l=`/${i}${l}`,i=proxyhosts[Math.floor(Math.random()*proxyhosts.length)],d=" 已启用临时域名中转服务，请尽快绑定自定义域！");const p=proxyIPPool.find((e=>e.includes(r)));p&&(l+=`&proxyip=${p}`);let u=s;t.includes("subconverter")||(u=encodeURIComponent(s));return`${atob("dHJvamFu")}://${u}@${r}:${o}?security=tls&sni=${i}&fp=randomized&type=ws&host=${i}&path=${encodeURIComponent(l)}#${encodeURIComponent(n+d)}`})).join("\n");return btoa(n)}async function getAddressesapi(e){if(!e||0===e.length)return[];let s="";const t=new AbortController,r=setTimeout((()=>{t.abort()}),2e3);try{const r=await Promise.allSettled(e.map((e=>fetch(e,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","User-Agent":atob("Q0YtV29ya2Vycy1lcGVpdXMvY21saXU=")},signal:t.signal}).then((e=>e.ok?e.text():Promise.reject())))));for(const[t,o]of r.entries())if("fulfilled"===o.status){const r=await o.value,n=r.split(/\r?\n/);let a="",c="443";if(n[0].split(",").length>3){const r=e[t].match(/id=([^&]*)/);r&&(a=r[1]);const o=e[t].match(/port=([^&]*)/);o&&(c=o[1]);for(let r=1;r<n.length;r++){const o=n[r].split(",")[0];o&&(s+=`${o}:${c}${a?`#${a}`:""}\n`,e[t].includes("proxyip=true")&&proxyIPPool.push(`${o}:${c}`))}}else e[t].includes("proxyip=true")&&(proxyIPPool=proxyIPPool.concat((await ADD(r)).map((e=>{const s=e.split("#")[0]||e;if(!s.includes(":"))return`${s}:443`;{const e=s.split(":")[1];if(!httpsPorts.includes(e))return s}return null})).filter(Boolean))),s+=r+"\n"}}catch(e){console.error(e)}finally{clearTimeout(r)}return await ADD(s)}async function getAddressescsv(e){if(!addressescsv||0===addressescsv.length)return[];let s=[];for(const t of addressescsv)try{const r=await fetch(t);if(!r.ok){console.error("获取CSV地址时出错:",r.status,r.statusText);continue}const o=await r.text();let n;n=o.includes("\r\n")?o.split("\r\n"):o.split("\n");const a=n[0].split(",").indexOf("TLS"),c=0,i=1,l=a+remarkIndex;if(-1===a){console.error("CSV文件缺少必需的字段");continue}for(let r=1;r<n.length;r++){const o=n[r].split(","),d=o.length-1;if(o[a].toUpperCase()===e&&parseFloat(o[d])>DLS){const e=o[c],r=o[i],n=`${e}:${r}#${o[l]}`;s.push(n),t.includes("proxyip=true")&&"true"==o[a].toUpperCase()&&!httpsPorts.includes(r)&&proxyIPPool.push(`${e}:${r}`)}}}catch(e){console.error("获取CSV地址时出错:",e);continue}return s}function surge(e,s){let t;t=e.includes("\r\n")?e.split("\r\n"):e.split("\n");let r="";for(let e of t)if(e.includes(atob("PSB0cm9qYW4s"))){const s=e.split("sni=")[1].split(",")[0],t="skip-cert-verify=true, tfo=false, udp-relay=false",o=`skip-cert-verify=true, ws=true, ws-path=${path}, ws-headers=Host:"${s}", tfo=false, udp-relay=false`;r+=e.replace(new RegExp(t,"g"),o).replace("[","").replace("]","")+"\n"}else r+=e+"\n";return r=`#!MANAGED-CONFIG ${s} interval=86400 strict=false`+r.substring(r.indexOf("\n")),r}
/**
 * [js-sha256]{@link https://github.com/emn178/js-sha256}
 * 
 * @version 0.11.0 (modified by cmliu)
 * @description 本代码基于 js-sha256 项目改编，添加了 SHA-224 哈希算法的实现。
 * @author Chen, Yi-Cyuan [emn178@gmail.com], modified by cmliu
 * @copyright Chen, Yi-Cyuan 2014-2024
 * @license MIT
 * 
 * @modifications 重写并实现了 sha224 函数，引用请注明出处。修改日期：2024-12-04，Github：cmliu
 */function sha224(e){const s=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function 右旋转(e,s){return(e>>>s|e<<32-s)>>>0}const t=function(e){let t=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428];const r=8*e.length;for(e+=String.fromCharCode(128);8*e.length%512!=448;)e+=String.fromCharCode(0);const o=Math.floor(r/4294967296),n=4294967295&r;e+=String.fromCharCode(o>>>24&255,o>>>16&255,o>>>8&255,255&o,n>>>24&255,n>>>16&255,n>>>8&255,255&n);const a=[];for(let s=0;s<e.length;s+=4)a.push(e.charCodeAt(s)<<24|e.charCodeAt(s+1)<<16|e.charCodeAt(s+2)<<8|e.charCodeAt(s+3));for(let e=0;e<a.length;e+=16){const r=new Array(64).fill(0);for(let s=0;s<16;s++)r[s]=a[e+s];for(let e=16;e<64;e++){const s=右旋转(r[e-15],7)^右旋转(r[e-15],18)^r[e-15]>>>3,t=右旋转(r[e-2],17)^右旋转(r[e-2],19)^r[e-2]>>>10;r[e]=r[e-16]+s+r[e-7]+t>>>0}let[o,n,c,i,l,d,p,u]=t;for(let e=0;e<64;e++){const t=u+(右旋转(l,6)^右旋转(l,11)^右旋转(l,25))+(l&d^~l&p)+s[e]+r[e]>>>0,a=o&n^o&c^n&c;u=p,p=d,d=l,l=i+t>>>0,i=c,c=n,n=o,o=t+((右旋转(o,2)^右旋转(o,13)^右旋转(o,22))+a>>>0)>>>0}t[0]=t[0]+o>>>0,t[1]=t[1]+n>>>0,t[2]=t[2]+c>>>0,t[3]=t[3]+i>>>0,t[4]=t[4]+l>>>0,t[5]=t[5]+d>>>0,t[6]=t[6]+p>>>0,t[7]=t[7]+u>>>0}return t.slice(0,7)}(unescape(encodeURIComponent(e)));return function(e){let s="";for(let t=0;t<e.length;t++)s+=(e[t]>>>4&15).toString(16),s+=(15&e[t]).toString(16);return s}(t.flatMap((e=>[e>>>24&255,e>>>16&255,e>>>8&255,255&e])))}
