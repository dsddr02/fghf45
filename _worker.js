import{connect}from"cloudflare:sockets";let fakeUserID,fakeHostName,password="",proxyIP="",sub="",subConverter="SUBAPI.fxxk.dedyn.io",subConfig="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_MultiMode.ini",subProtocol="https",subEmoji="true",socks5Address="",parsedSocks5Address={},enableSocks=!1;const expire=4102329600;let proxyIPs,socks5s,sha224Password,go2Socks5s=["*ttvnw.net","*tapecontent.net","*cloudatacdn.com","*.loadshare.org"],addresses=[],addressesapi=[],addressescsv=[],DLS=8,remarkIndex=1,FileName="epeius",BotToken="",ChatID="",proxyhosts=[],proxyhostsURL="",RproxyIP="false",httpsPorts=["2053","2083","2087","2096","8443"];const regex=/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\[.*\]):?(\d+)?#?(.*)?$/;let proxyIPPool=[],path="/?ed=2560",link=[],banHosts=[atob("c3BlZWQuY2xvdWRmbGFyZS5jb20=")];export default{async fetch(t,e,s){try{const s=t.headers.get("User-Agent")||"null",r=s.toLowerCase();if(password=e.PASSWORD||e.pswd||e.UUID||e.uuid||password,!password)return new Response("请设置你的PASSWORD变量，或尝试重试部署，检查变量是否生效？",{status:404,headers:{"Content-Type":"text/plain;charset=utf-8"}});sha224Password=e.SHA224||e.SHA224PASS||sha224(password);const n=new Date;n.setHours(0,0,0,0);const o=Math.ceil(n.getTime()/1e3),a=await MD5MD5(`${password}${o}`);if(fakeUserID=[a.slice(0,8),a.slice(8,12),a.slice(12,16),a.slice(16,20),a.slice(20)].join("-"),fakeHostName=`${a.slice(6,9)}.${a.slice(13,19)}`,proxyIP=e.PROXYIP||e.proxyip||proxyIP,proxyIPs=await ADD(proxyIP),proxyIP=proxyIPs[Math.floor(Math.random()*proxyIPs.length)],socks5Address=e.SOCKS5||socks5Address,socks5s=await ADD(socks5Address),socks5Address=socks5s[Math.floor(Math.random()*socks5s.length)],socks5Address=socks5Address.split("//")[1]||socks5Address,e.GO2SOCKS5&&(go2Socks5s=await ADD(e.GO2SOCKS5)),e.CFPORTS&&(httpsPorts=await ADD(e.CFPORTS)),e.BAN&&(banHosts=await 整理(e.BAN)),socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),RproxyIP=e.RPROXYIP||"false",enableSocks=!0}catch(t){let s=t;console.log(s.toString()),RproxyIP=e.RPROXYIP||!proxyIP?"true":"false",enableSocks=!1}else RproxyIP=e.RPROXYIP||!proxyIP?"true":"false";const l=t.headers.get("Upgrade"),i=new URL(t.url);if(l&&"websocket"===l){if(socks5Address=i.searchParams.get("socks5")||socks5Address,new RegExp("/socks5=","i").test(i.pathname))socks5Address=i.pathname.split("5=")[1];else if((new RegExp("/socks://","i").test(i.pathname)||new RegExp("/socks5://","i").test(i.pathname))&&(socks5Address=i.pathname.split("://")[1].split("#")[0],socks5Address.includes("@"))){let t=socks5Address.split("@")[0];/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=)?$/i.test(t)&&!t.includes(":")&&(t=atob(t)),socks5Address=`${t}@${socks5Address.split("@")[1]}`}if(socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),enableSocks=!0}catch(t){let e=t;console.log(e.toString()),enableSocks=!1}else enableSocks=!1;return i.searchParams.has("proxyip")?(proxyIP=i.searchParams.get("proxyip"),enableSocks=!1):new RegExp("/proxyip=","i").test(i.pathname)?(proxyIP=i.pathname.toLowerCase().split("/proxyip=")[1],enableSocks=!1):new RegExp("/proxyip.","i").test(i.pathname)&&(proxyIP=`proxyip.${i.pathname.toLowerCase().split("/proxyip.")[1]}`,enableSocks=!1),await 特洛伊OverWSHandler(t)}switch(e.ADD&&(addresses=await ADD(e.ADD)),e.ADDAPI&&(addressesapi=await ADD(e.ADDAPI)),e.ADDCSV&&(addressescsv=await ADD(e.ADDCSV)),DLS=Number(e.DLS)||DLS,remarkIndex=Number(e.CSVREMARK)||remarkIndex,BotToken=e.TGTOKEN||BotToken,ChatID=e.TGID||ChatID,FileName=e.SUBNAME||FileName,subEmoji=e.SUBEMOJI||e.EMOJI||subEmoji,"0"==subEmoji&&(subEmoji="false"),e.LINK&&(link=await ADD(e.LINK)),sub=e.SUB||sub,subConverter=e.SUBAPI||subConverter,subConverter.includes("http://")?(subConverter=subConverter.split("//")[1],subProtocol="http"):subConverter=subConverter.split("//")[1]||subConverter,subConfig=e.SUBCONFIG||subConfig,i.searchParams.has("sub")&&""!==i.searchParams.get("sub")&&(sub=i.searchParams.get("sub")),i.searchParams.has("proxyip")?(path=`/?ed=2560&proxyip=${i.searchParams.get("proxyip")}`,RproxyIP="false"):i.searchParams.has("socks5")?(path=`/?ed=2560&socks5=${i.searchParams.get("socks5")}`,RproxyIP="false"):i.searchParams.has("socks")&&(path=`/?ed=2560&socks5=${i.searchParams.get("socks")}`,RproxyIP="false"),i.pathname){case"/":return e.URL302?Response.redirect(e.URL302,302):e.URL?await proxyURL(e.URL,i):new Response(JSON.stringify(t.cf,null,4),{status:200,headers:{"content-type":"application/json"}});case`/${fakeUserID}`:const n=await get特洛伊Config(password,t.headers.get("Host"),sub,"CF-Workers-SUB",RproxyIP,i,e);return new Response(`${n}`,{status:200});case`/${password}/edit`:return await KV(t,e);case`/${password}`:await sendMessage(`#获取订阅 ${FileName}`,t.headers.get("CF-Connecting-IP"),`UA: ${s}</tg-spoiler>\n域名: ${i.hostname}\n<tg-spoiler>入口: ${i.pathname+i.search}</tg-spoiler>`);const o=await get特洛伊Config(password,t.headers.get("Host"),sub,s,RproxyIP,i,e),a=Date.now(),l=new Date(a);l.setHours(0,0,0,0);const c=Math.floor((a-l.getTime())/864e5*24*1099511627776/2);let d=c,p=c,u=26388279066624;return r&&(r.includes("mozilla")||r.includes("subconverter"))?new Response(`<div style="font-size:13px;">${o}</div>`,{status:200,headers:{"Content-Type":"text/html;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${d}; download=${p}; total=${u}; expire=${expire}`,"Cache-Control":"no-store"}}):new Response(`${o}`,{status:200,headers:{"Content-Disposition":`attachment; filename=${FileName}; filename*=utf-8''${encodeURIComponent(FileName)}`,"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${d}; download=${p}; total=${u}; expire=${expire}`}});default:return e.URL302?Response.redirect(e.URL302,302):e.URL?await proxyURL(e.URL,i):new Response("不用怀疑！你PASSWORD就是错的！！！",{status:404})}}catch(t){return new Response(t.toString())}}};async function 特洛伊OverWSHandler(t){const e=new WebSocketPair,[s,r]=Object.values(e);r.accept();let n="",o="";const log=(t,e)=>{console.log(`[${n}:${o}] ${t}`,e||"")},a=t.headers.get("sec-websocket-protocol")||"",l=makeReadableWebSocketStream(r,a,log);let i={value:null};return l.pipeTo(new WritableStream({async write(t,e){if(i.value){const e=i.value.writable.getWriter();return await e.write(t),void e.releaseLock()}const{hasError:s,message:a,portRemote:l=443,addressRemote:c="",rawClientData:d,addressType:p}=await parse特洛伊Header(t);if(n=c,o=`${l}--${Math.random()} tcp`,s)throw new Error(a);if(banHosts.includes(c))throw new Error(`黑名单关闭 TCP 出站连接 ${c}:${l}`);log(`处理 TCP 出站连接 ${c}:${l}`),handleTCPOutBound(i,c,l,d,r,log,p)},close(){log("readableWebSocketStream is closed")},abort(t){log("readableWebSocketStream is aborted",JSON.stringify(t))}})).catch((t=>{log("readableWebSocketStream pipeTo error",t)})),new Response(null,{status:101,webSocket:s})}async function parse特洛伊Header(t){if(t.byteLength<56)return{hasError:!0,message:"invalid data"};if(13!==new Uint8Array(t.slice(56,57))[0]||10!==new Uint8Array(t.slice(57,58))[0])return{hasError:!0,message:"invalid header format (missing CR LF)"};if((new TextDecoder).decode(t.slice(0,56))!==sha224Password)return{hasError:!0,message:"invalid password"};const e=t.slice(58);if(e.byteLength<6)return{hasError:!0,message:"invalid SOCKS5 request data"};const s=new DataView(e);if(1!==s.getUint8(0))return{hasError:!0,message:"unsupported command, only TCP (CONNECT) is allowed"};const r=s.getUint8(1);let n=0,o=2,a="";switch(r){case 1:n=4,a=new Uint8Array(e.slice(o,o+n)).join(".");break;case 3:n=new Uint8Array(e.slice(o,o+1))[0],o+=1,a=(new TextDecoder).decode(e.slice(o,o+n));break;case 4:n=16;const t=new DataView(e.slice(o,o+n)),s=[];for(let e=0;e<8;e++)s.push(t.getUint16(2*e).toString(16));a=s.join(":");break;default:return{hasError:!0,message:`invalid addressType is ${r}`}}if(!a)return{hasError:!0,message:`address is empty, addressType is ${r}`};const l=o+n,i=e.slice(l,l+2);return{hasError:!1,addressRemote:a,portRemote:new DataView(i).getUint16(0),rawClientData:e.slice(l+4),addressType:r}}async function handleTCPOutBound(t,e,s,r,n,o,a){async function connectAndWrite(e,s,n=!1){o(`connected to ${e}:${s}`);const l=n?await socks5Connect(a,e,s,o):connect({hostname:e,port:s});t.value=l;const i=l.writable.getWriter();return await i.write(r),i.releaseLock(),l}let l=!1;go2Socks5s.length>0&&enableSocks&&(l=await async function(t){return!(!go2Socks5s.includes(atob("YWxsIGlu"))&&!go2Socks5s.includes(atob("Kg==")))||go2Socks5s.some((e=>{let s=e.replace(/\*/g,".*");return new RegExp(`^${s}$`,"i").test(t)}))}(e));let i=await connectAndWrite(e,s,l);remoteSocketToWS(i,n,(async function(){enableSocks?i=await connectAndWrite(e,s,!0):(proxyIP&&""!=proxyIP?proxyIP.includes("]:")?(s=proxyIP.split("]:")[1]||s,proxyIP=proxyIP.split("]:")[0]||proxyIP):2===proxyIP.split(":").length&&(s=proxyIP.split(":")[1]||s,proxyIP=proxyIP.split(":")[0]||proxyIP):proxyIP=atob("UFJPWFlJUC50cDEuZnh4ay5kZWR5bi5pbw=="),proxyIP.includes(".tp")&&(s=proxyIP.split(".tp")[1].split(".")[0]||s),i=await connectAndWrite(proxyIP||e,s)),i.closed.catch((t=>{console.log("retry tcpSocket closed error",t)})).finally((()=>{safeCloseWebSocket(n)})),remoteSocketToWS(i,n,null,o)}),o)}function makeReadableWebSocketStream(t,e,s){let r=!1;return new ReadableStream({start(n){t.addEventListener("message",(t=>{if(r)return;const e=t.data;n.enqueue(e)})),t.addEventListener("close",(()=>{safeCloseWebSocket(t),r||n.close()})),t.addEventListener("error",(t=>{s("webSocketServer error"),n.error(t)}));const{earlyData:o,error:a}=base64ToArrayBuffer(e);a?n.error(a):o&&n.enqueue(o)},pull(t){},cancel(e){r||(s(`readableStream was canceled, due to ${e}`),r=!0,safeCloseWebSocket(t))}})}async function remoteSocketToWS(t,e,s,r){let n=!1;await t.readable.pipeTo(new WritableStream({start(){},async write(t,s){n=!0,e.readyState!==WS_READY_STATE_OPEN&&s.error("webSocket connection is not open"),e.send(t)},close(){r(`remoteSocket.readable is closed, hasIncomingData: ${n}`)},abort(t){console.error("remoteSocket.readable abort",t)}})).catch((t=>{console.error("remoteSocketToWS error:",t.stack||t),safeCloseWebSocket(e)})),!1===n&&s&&(r("retry"),s())}function base64ToArrayBuffer(t){if(!t)return{earlyData:void 0,error:null};try{t=t.replace(/-/g,"+").replace(/_/g,"/");const e=atob(t);return{earlyData:Uint8Array.from(e,(t=>t.charCodeAt(0))).buffer,error:null}}catch(t){return{earlyData:void 0,error:t}}}let WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(t){try{t.readyState!==WS_READY_STATE_OPEN&&t.readyState!==WS_READY_STATE_CLOSING||t.close()}catch(t){console.error("safeCloseWebSocket error",t)}}function revertFakeInfo(t,e,s,r){return r&&(t=atob(t)),t=t.replace(new RegExp(fakeUserID,"g"),e).replace(new RegExp(fakeHostName,"g"),s),r&&(t=btoa(t)),t}async function MD5MD5(t){const e=new TextEncoder,s=await crypto.subtle.digest("MD5",e.encode(t)),r=Array.from(new Uint8Array(s)).map((t=>t.toString(16).padStart(2,"0"))).join(""),n=await crypto.subtle.digest("MD5",e.encode(r.slice(7,27)));return Array.from(new Uint8Array(n)).map((t=>t.toString(16).padStart(2,"0"))).join("").toLowerCase()}async function ADD(t){var e=t.replace(/[	|"'\r\n]+/g,",").replace(/,+/g,",");","==e.charAt(0)&&(e=e.slice(1)),","==e.charAt(e.length-1)&&(e=e.slice(0,e.length-1));return e.split(",")}async function proxyURL(t,e){const s=await ADD(t),r=s[Math.floor(Math.random()*s.length)];let n=new URL(r);console.log(n);let o=n.protocol.slice(0,-1)||"https",a=n.hostname,l=n.pathname,i=n.search;"/"==l.charAt(l.length-1)&&(l=l.slice(0,-1)),l+=e.pathname;let c=`${o}://${a}${l}${i}`,d=await fetch(c),p=new Response(d.body,{status:d.status,statusText:d.statusText,headers:d.headers});return p.headers.set("X-New-URL",c),p}function 配置信息(t,e){const s=atob("dHJvamFu"),r=FileName;let n=e;const o=e,a=path;const l=e,i="randomized";return[`${s}://${encodeURIComponent(t)}@${n}:443?security=tls&sni=${l}&alpn=h3&fp=${i}&allowInsecure=1&type=ws&host=${o}&path=${encodeURIComponent(a)}#${encodeURIComponent(r)}`,`- {name: ${r}, server: ${n}, port: 443, udp: false, client-fingerprint: ${i}, type: ${s}, password: ${t}, sni: ${l}, alpn: [h3], skip-cert-verify: true, network: ws, ws-opts: {path: "${a}", headers: {Host: ${o}}}}`]}let subParams=["sub","base64","b64","clash","singbox","sb","surge"];const cmad=decodeURIComponent(atob("dGVsZWdyYW0lMjAlRTQlQkElQTQlRTYlQjUlODElRTclQkUlQTQlMjAlRTYlOEElODAlRTYlOUMlQUYlRTUlQTQlQTclRTQlQkQlQUMlN0UlRTUlOUMlQTglRTclQkElQkYlRTUlOEYlOTElRTclODklOEMhJTNDYnIlM0UKJTNDYSUyMGhyZWYlM0QlMjdodHRwcyUzQSUyRiUyRnQubWUlMkZDTUxpdXNzc3MlMjclM0VodHRwcyUzQSUyRiUyRnQubWUlMkZDTUxpdXNzc3MlM0MlMkZhJTNFJTNDYnIlM0UKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJTNDYnIlM0UKZ2l0aHViJTIwJUU5JUExJUI5JUU3JTlCJUFFJUU1JTlDJUIwJUU1JTlEJTgwJTIwU3RhciFTdGFyIVN0YXIhISElM0NiciUzRQolM0NhJTIwaHJlZiUzRCUyN2h0dHBzJTNBJTJGJTJGZ2l0aHViLmNvbSUyRmNtbGl1JTJGZXBlaXVzJTI3JTNFaHR0cHMlM0ElMkYlMkZnaXRodWIuY29tJTJGY21saXUlMkZlcGVpdXMlM0MlMkZhJTNFJTNDYnIlM0UKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJTNDYnIlM0UKJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIz"));async function get特洛伊Config(t,e,s,r,n,o,a){if(s){const t=s.match(/^(?:https?:\/\/)?([^\/]+)/);t&&(s=t[1]);const e=await ADD(s);e.length>1&&(s=e[0])}else{if(a.KV){const t=await a.KV.get("/ADD.txt");if(t){const e=await ADD(t),s={"接口地址":new Set,"链接地址":new Set,"优选地址":new Set};for(const t of e)t.startsWith("https://")?s.接口地址.add(t):t.includes("://")?s.链接地址.add(t):s.优选地址.add(t);addressesapi=[...s.接口地址],link=[...s.链接地址],addresses=[...s.优选地址]}}if(addresses.length+addressesapi.length+addressescsv.length==0){let t=["103.21.244.0/23","104.16.0.0/13","104.24.0.0/14","172.64.0.0/14","103.21.244.0/23","104.16.0.0/14","104.24.0.0/15","141.101.64.0/19","172.64.0.0/14","188.114.96.0/21","190.93.240.0/21"];addresses=addresses.concat("127.0.0.1:1234#CFnat"),addresses=addresses.concat(t.map((t=>function(t){const[e,s]=t.split("/"),r=e.split(".").map(Number),n=32-parseInt(s,10),o=Math.pow(2,n)-1,a=Math.floor(Math.random()*o);return r.map(((t,e)=>e<2?t:2===e?(t&255<<n-8)+(a>>8&255):(t&255<<n)+(255&a))).join(".")}(t)+"#CF随机节点")))}}const l=r.toLowerCase(),i=配置信息(t,e),c=i[0],d=i[1];let p="";if(e.includes(".workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{const t=await fetch(proxyhostsURL);if(!t.ok)return void console.error("获取地址时出错:",t.status,t.statusText);const e=await t.text(),s=e.split("\n").filter((t=>""!==t.trim()));proxyhosts=proxyhosts.concat(s)}catch(t){}0!=proxyhosts.length&&(p=proxyhosts[Math.floor(Math.random()*proxyhosts.length)]+"/")}if(l.includes("mozilla")&&!subParams.some((t=>o.searchParams.has(t)))){let l=`Surge订阅地址:<br><a href="javascript:void(0)" onclick="copyToClipboard('https://${p}${e}/${t}?surge')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${p}${e}/${t}?surge</a>`;e.includes(".workers.dev")&&(l="Surge订阅必须绑定自定义域");const i=socks5s.map((t=>t.includes("@")?t.split("@")[1]:t.includes("//")?t.split("//")[1]:t));let u="";go2Socks5s.length>0&&enableSocks&&(u=`${decodeURIComponent("SOCKS5%EF%BC%88%E7%99%BD%E5%90%8D%E5%8D%95%EF%BC%89%3A%20")}`,go2Socks5s.includes(atob("YWxsIGlu"))||go2Socks5s.includes(atob("Kg=="))?u+=`${decodeURIComponent("%E6%89%80%E6%9C%89%E6%B5%81%E9%87%8F")}<br>`:u+=`<br>&nbsp;&nbsp;${go2Socks5s.join("<br>&nbsp;&nbsp;")}<br>`);let h="";if(s)h+=enableSocks?`CFCDN（访问方式）: Socks5<br>&nbsp;&nbsp;${i.join("<br>&nbsp;&nbsp;")}<br>${u}`:proxyIP&&""!=proxyIP?`CFCDN（访问方式）: ProxyIP<br>&nbsp;&nbsp;${proxyIPs.join("<br>&nbsp;&nbsp;")}<br>`:"true"==n?"CFCDN（访问方式）: 自动获取ProxyIP<br>":"CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！<br>",h+=`<br>SUB（优选订阅生成器）: ${s}`;else{h+=enableSocks?`CFCDN（访问方式）: Socks5<br>&nbsp;&nbsp;${i.join("<br>&nbsp;&nbsp;")}<br>${u}`:proxyIP&&""!=proxyIP?`CFCDN（访问方式）: ProxyIP<br>&nbsp;&nbsp;${proxyIPs.join("<br>&nbsp;&nbsp;")}<br>`:"CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！<br>";let t="";a.KV&&(t=` <a href='${o.pathname}/edit'>编辑优选列表</a>`),h+=`<br>您的订阅内容由 内置 addresses/ADD* 参数变量提供${t}<br>`,addresses.length>0&&(h+=`ADD（TLS优选域名&IP）: <br>&nbsp;&nbsp;${addresses.join("<br>&nbsp;&nbsp;")}<br>`),addressesapi.length>0&&(h+=`ADDAPI（TLS优选域名&IP 的 API）: <br>&nbsp;&nbsp;${addressesapi.join("<br>&nbsp;&nbsp;")}<br>`),addressescsv.length>0&&(h+=`ADDCSV（IPTest测速csv文件 限速 ${DLS} ）: <br>&nbsp;&nbsp;${addressescsv.join("<br>&nbsp;&nbsp;")}<br>`)}return`\n\t\t\t################################################################<br>\n\t\t\tSubscribe / sub 订阅地址, 支持 Base64、clash-meta、sing-box 订阅格式<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t自适应订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${p}${e}/${t}')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${p}${e}/${t}</a><br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${p}${e}/${t}?sub')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${p}${e}/${t}?sub</a><br>\n\t\t\t<br>\n\t\t\tBase64订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${p}${e}/${t}?b64')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${p}${e}/${t}?b64</a><br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${p}${e}/${t}?base64')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${p}${e}/${t}?base64</a><br>\n\t\t\t<br>\n\t\t\tclash订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${p}${e}/${t}?clash')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${p}${e}/${t}?clash</a><br>\n\t\t\t<br>\n\t\t\tsingbox订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${p}${e}/${t}?sb')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${p}${e}/${t}?sb</a><br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${p}${e}/${t}?singbox')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${p}${e}/${t}?singbox</a><br>\n\t\t\t<br>\n\t\t\t${l}<br>\n\n\t\t\t<script>\n\t\t\tfunction copyToClipboard(text) {\n\t\t\t\tnavigator.clipboard.writeText(text).then(() => {\n\t\t\t\t\talert('已复制到剪贴板');\n\t\t\t\t}).catch(err => {\n\t\t\t\t\tconsole.error('复制失败:', err);\n\t\t\t\t});\n\t\t\t}\n\t\t\t<\/script>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\t${FileName} 配置信息<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\tHOST: ${e}<br>\n\t\t\tPASSWORD: ${t}<br>\n\t\t\tSHA224: ${sha224Password}<br>\n\t\t\tFAKEPASS: ${fakeUserID}<br>\n\t\t\tUA: ${r}<br>\n\t\t\t<br>\n\t\t\t${h}<br>\n\t\t\tSUBAPI（订阅转换后端）: ${subProtocol}://${subConverter}<br>\n\t\t\tSUBCONFIG（订阅转换配置文件）: ${subConfig}<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\tv2ray<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('${c}')" style="color:blue;text-decoration:underline;cursor:pointer;">${c}</a><br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\tclash-meta<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t${d}<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\t${cmad}\n\t\t\t`}{if("function"!=typeof fetch)return"Error: fetch is not available in this environment.";fakeHostName=e.includes(".workers.dev")?`${fakeHostName}.workers.dev`:`${fakeHostName}.xyz`;let r=`https://${s}/sub?host=${fakeHostName}&pw=${fakeUserID}&password=${fakeUserID+atob("JmVwZWl1cz1jbWxpdSZwcm94eWlwPQ==")+n}&path=${encodeURIComponent(path)}`,a=!0,i=[],c=[];if(!s||""==s){if(e.includes("workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{const t=await fetch(proxyhostsURL);if(!t.ok)return void console.error("获取地址时出错:",t.status,t.statusText);const e=await t.text(),s=e.split("\n").filter((t=>""!==t.trim()));proxyhosts=proxyhosts.concat(s)}catch(t){console.error("获取地址时出错:",t)}proxyhosts=[...new Set(proxyhosts)]}i=await getAddressesapi(addressesapi),c=await getAddressescsv("TRUE"),r=`https://${e}/${fakeUserID+o.search}`}l.includes("CF-Workers-SUB".toLowerCase())||(l.includes("clash")&&!l.includes("nekobox")||o.searchParams.has("clash")?(r=`${subProtocol}://${subConverter}/sub?target=clash&url=${encodeURIComponent(r)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,a=!1):l.includes("sing-box")||l.includes("singbox")||o.searchParams.has("singbox")||o.searchParams.has("sb")?(r=`${subProtocol}://${subConverter}/sub?target=singbox&url=${encodeURIComponent(r)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,a=!1):(l.includes("surge")||o.searchParams.has("surge"))&&(r=`${subProtocol}://${subConverter}/sub?target=surge&ver=4&url=${encodeURIComponent(r)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&xudp=false&udp=false&tfo=false&expand=true&scv=true&fdn=false`,a=!1));try{let n;if(s&&""!=s||1!=a){const t=await fetch(r,{headers:{"User-Agent":atob("Q0YtV29ya2Vycy1lcGVpdXMvY21saXU=")}});n=await t.text()}else n=await subAddresses(fakeHostName,fakeUserID,l,i,c);return o.pathname==`/${fakeUserID}`||(n=revertFakeInfo(n,t,e,a),(l.includes("surge")||o.searchParams.has("surge"))&&(n=surge(n,`https://${e}/${t}?surge`))),n}catch(t){return console.error("Error fetching content:",t),`Error fetching content: ${t.message}`}}}async function sendMessage(t,e,s=""){if(""!==BotToken&&""!==ChatID){let r="";const n=await fetch(`http://ip-api.com/json/${e}?lang=zh-CN`);if(200==n.status){const o=await n.json();r=`${t}\nIP: ${e}\n国家: ${o.country}\n<tg-spoiler>城市: ${o.city}\n组织: ${o.org}\nASN: ${o.as}\n${s}`}else r=`${t}\nIP: ${e}\n<tg-spoiler>${s}`;let o="https://api.telegram.org/bot"+BotToken+"/sendMessage?chat_id="+ChatID+"&parse_mode=HTML&text="+encodeURIComponent(r);return fetch(o,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","Accept-Encoding":"gzip, deflate, br","User-Agent":"Mozilla/5.0 Chrome/90.0.4430.72"}})}}async function socks5Connect(t,e,s,r){const{username:n,password:o,hostname:a,port:l}=parsedSocks5Address,i=connect({hostname:a,port:l}),c=new Uint8Array([5,2,0,2]),d=i.writable.getWriter();await d.write(c),r("sent socks greeting");const p=i.readable.getReader(),u=new TextEncoder;let h,b=(await p.read()).value;if(5!==b[0])return void r(`socks server version error: ${b[0]} expected: 5`);if(255===b[1])return void r("no acceptable methods");if(2===b[1]){if(r("socks server needs auth"),!n||!o)return void r("please provide username/password");const t=new Uint8Array([1,n.length,...u.encode(n),o.length,...u.encode(o)]);if(await d.write(t),b=(await p.read()).value,1!==b[0]||0!==b[1])return void r("fail to auth socks server")}switch(t){case 1:h=new Uint8Array([1,...e.split(".").map(Number)]);break;case 3:h=new Uint8Array([3,e.length,...u.encode(e)]);break;case 4:h=new Uint8Array([4,...e.split(":").flatMap((t=>[parseInt(t.slice(0,2),16),parseInt(t.slice(2),16)]))]);break;default:return void r(`invild  addressType is ${t}`)}const f=new Uint8Array([5,1,0,...h,s>>8,255&s]);if(await d.write(f),r("sent socks request"),b=(await p.read()).value,0===b[1])return r("socks connection opened"),d.releaseLock(),p.releaseLock(),i;r("fail to open socks connection")}function socks5AddressParser(t){let e,s,r,n,[o,a]=t.split("@").reverse();if(a){const t=a.split(":");if(2!==t.length)throw new Error("Invalid SOCKS address format");[e,s]=t}const l=o.split(":");if(n=Number(l.pop()),isNaN(n))throw new Error("Invalid SOCKS address format");r=l.join(":");if(r.includes(":")&&!/^\[.*\]$/.test(r))throw new Error("Invalid SOCKS address format");return{username:e,password:s,hostname:r,port:n}}function isValidIPv4(t){return/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(t)}function subAddresses(t,e,s,r,n){addresses=addresses.concat(r),addresses=addresses.concat(n);const o=[...new Set(addresses)].map((r=>{let n="-1",o=r;const a=o.match(regex);if(a)r=a[1],n=a[2]||n,o=a[3]||r;else{if(r.includes(":")&&r.includes("#")){const t=r.split(":");r=t[0];const e=t[1].split("#");n=e[0],o=e[1]}else if(r.includes(":")){const t=r.split(":");r=t[0],n=t[1]}else if(r.includes("#")){const t=r.split("#");r=t[0],o=t[1]}o.includes(":")&&(o=o.split(":")[0])}const l=["2053","2083","2087","2096","8443"];if(!isValidIPv4(r)&&"-1"==n)for(let t of l)if(r.includes(t)){n=t;break}"-1"==n&&(n="443");let i=t,c=path,d="";proxyhosts.length>0&&i.includes(".workers.dev")&&(c=`/${i}${c}`,i=proxyhosts[Math.floor(Math.random()*proxyhosts.length)],d=" 已启用临时域名中转服务，请尽快绑定自定义域！");const p=proxyIPPool.find((t=>t.includes(r)));p&&(c+=`&proxyip=${p}`);let u=e;s.includes("subconverter")||(u=encodeURIComponent(e));return`${atob("dHJvamFu")}://${u}@${r}:${n}?security=tls&sni=${i}&fp=randomized&type=ws&host=${i}&path=${encodeURIComponent(c)}#${encodeURIComponent(o+d)}`})).join("\n");let a=o;return link.length>0&&(a+="\n"+link.join("\n")),btoa(a)}async function getAddressesapi(t){if(!t||0===t.length)return[];let e="";const s=new AbortController,r=setTimeout((()=>{s.abort()}),2e3);try{const r=await Promise.allSettled(t.map((t=>fetch(t,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","User-Agent":atob("Q0YtV29ya2Vycy1lcGVpdXMvY21saXU=")},signal:s.signal}).then((t=>t.ok?t.text():Promise.reject())))));for(const[s,n]of r.entries())if("fulfilled"===n.status){const r=await n.value,o=r.split(/\r?\n/);let a="",l="443";if(o[0].split(",").length>3){const r=t[s].match(/id=([^&]*)/);r&&(a=r[1]);const n=t[s].match(/port=([^&]*)/);n&&(l=n[1]);for(let r=1;r<o.length;r++){const n=o[r].split(",")[0];n&&(e+=`${n}:${l}${a?`#${a}`:""}\n`,t[s].includes("proxyip=true")&&proxyIPPool.push(`${n}:${l}`))}}else t[s].includes("proxyip=true")&&(proxyIPPool=proxyIPPool.concat((await ADD(r)).map((t=>{const e=t.split("#")[0]||t;if(!e.includes(":"))return`${e}:443`;{const t=e.split(":")[1];if(!httpsPorts.includes(t))return e}return null})).filter(Boolean))),e+=r+"\n"}}catch(t){console.error(t)}finally{clearTimeout(r)}return await ADD(e)}async function getAddressescsv(t){if(!addressescsv||0===addressescsv.length)return[];let e=[];for(const s of addressescsv)try{const r=await fetch(s);if(!r.ok){console.error("获取CSV地址时出错:",r.status,r.statusText);continue}const n=await r.text();let o;o=n.includes("\r\n")?n.split("\r\n"):n.split("\n");const a=o[0].split(",").indexOf("TLS"),l=0,i=1,c=a+remarkIndex;if(-1===a){console.error("CSV文件缺少必需的字段");continue}for(let r=1;r<o.length;r++){const n=o[r].split(","),d=n.length-1;if(n[a].toUpperCase()===t&&parseFloat(n[d])>DLS){const t=n[l],r=n[i],o=`${t}:${r}#${n[c]}`;e.push(o),s.includes("proxyip=true")&&"true"==n[a].toUpperCase()&&!httpsPorts.includes(r)&&proxyIPPool.push(`${t}:${r}`)}}}catch(t){console.error("获取CSV地址时出错:",t);continue}return e}function surge(t,e){let s;s=t.includes("\r\n")?t.split("\r\n"):t.split("\n");let r="";for(let t of s)if(t.includes(atob("PSB0cm9qYW4s"))){const e=t.split("sni=")[1].split(",")[0],s="skip-cert-verify=true, tfo=false, udp-relay=false",n=`skip-cert-verify=true, ws=true, ws-path=${path}, ws-headers=Host:"${e}", tfo=false, udp-relay=false`;r+=t.replace(new RegExp(s,"g"),n).replace("[","").replace("]","")+"\n"}else r+=t+"\n";return r=`#!MANAGED-CONFIG ${e} interval=86400 strict=false`+r.substring(r.indexOf("\n")),r}
/**
 * [js-sha256]{@link https://github.com/emn178/js-sha256}
 * 
 * @version 0.11.0 (modified by cmliu)
 * @description 本代码基于 js-sha256 项目改编，添加了 SHA-224 哈希算法的实现。
 * @author Chen, Yi-Cyuan [emn178@gmail.com], modified by cmliu
 * @copyright Chen, Yi-Cyuan 2014-2024
 * @license MIT
 * 
 * @modifications 重写并实现了 sha224 函数，引用请注明出处。修改日期：2024-12-04，Github：cmliu
 */function sha224(t){const e=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function 右旋转(t,e){return(t>>>e|t<<32-e)>>>0}const s=function(t){let s=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428];const r=8*t.length;for(t+=String.fromCharCode(128);8*t.length%512!=448;)t+=String.fromCharCode(0);const n=Math.floor(r/4294967296),o=4294967295&r;t+=String.fromCharCode(n>>>24&255,n>>>16&255,n>>>8&255,255&n,o>>>24&255,o>>>16&255,o>>>8&255,255&o);const a=[];for(let e=0;e<t.length;e+=4)a.push(t.charCodeAt(e)<<24|t.charCodeAt(e+1)<<16|t.charCodeAt(e+2)<<8|t.charCodeAt(e+3));for(let t=0;t<a.length;t+=16){const r=new Array(64).fill(0);for(let e=0;e<16;e++)r[e]=a[t+e];for(let t=16;t<64;t++){const e=右旋转(r[t-15],7)^右旋转(r[t-15],18)^r[t-15]>>>3,s=右旋转(r[t-2],17)^右旋转(r[t-2],19)^r[t-2]>>>10;r[t]=r[t-16]+e+r[t-7]+s>>>0}let[n,o,l,i,c,d,p,u]=s;for(let t=0;t<64;t++){const s=u+(右旋转(c,6)^右旋转(c,11)^右旋转(c,25))+(c&d^~c&p)+e[t]+r[t]>>>0,a=n&o^n&l^o&l;u=p,p=d,d=c,c=i+s>>>0,i=l,l=o,o=n,n=s+((右旋转(n,2)^右旋转(n,13)^右旋转(n,22))+a>>>0)>>>0}s[0]=s[0]+n>>>0,s[1]=s[1]+o>>>0,s[2]=s[2]+l>>>0,s[3]=s[3]+i>>>0,s[4]=s[4]+c>>>0,s[5]=s[5]+d>>>0,s[6]=s[6]+p>>>0,s[7]=s[7]+u>>>0}return s.slice(0,7)}(unescape(encodeURIComponent(t)));return function(t){let e="";for(let s=0;s<t.length;s++)e+=(t[s]>>>4&15).toString(16),e+=(15&t[s]).toString(16);return e}(s.flatMap((t=>[t>>>24&255,t>>>16&255,t>>>8&255,255&t])))}async function KV(t,e,s="/ADD.txt"){try{if("POST"===t.method){if(!e.KV)return new Response("未绑定KV空间",{status:400});try{const r=await t.text();return await e.KV.put(s,r),new Response("保存成功")}catch(t){return console.error("保存KV时发生错误:",t),new Response("保存失败: "+t.message,{status:500})}}let r="",n=!!e.KV;if(n)try{r=await e.KV.get(s)||""}catch(t){console.error("读取KV时发生错误:",t),r="读取数据时发生错误: "+t.message}const o=`\n\t\t<!DOCTYPE html>\n\t\t<html>\n\t\t<head>\n\t\t\t<title>优选订阅列表</title>\n\t\t\t<meta charset="utf-8">\n\t\t\t<meta name="viewport" content="width=device-width, initial-scale=1">\n\t\t\t<style>\n\t\t\t\tbody {\n\t\t\t\t\tmargin: 0;\n\t\t\t\t\tpadding: 15px; /* 调整padding */\n\t\t\t\t\tbox-sizing: border-box;\n\t\t\t\t\tfont-size: 13px; /* 设置全局字体大小 */\n\t\t\t\t}\n\t\t\t\t.editor-container {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\tmax-width: 100%;\n\t\t\t\t\tmargin: 0 auto;\n\t\t\t\t}\n\t\t\t\t.editor {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 520px; /* 调整高度 */\n\t\t\t\t\tmargin: 15px 0; /* 调整margin */\n\t\t\t\t\tpadding: 10px; /* 调整padding */\n\t\t\t\t\tbox-sizing: border-box;\n\t\t\t\t\tborder: 1px solid #ccc;\n\t\t\t\t\tborder-radius: 4px;\n\t\t\t\t\tfont-size: 13px;\n\t\t\t\t\tline-height: 1.5;\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t\tresize: none;\n\t\t\t\t}\n\t\t\t\t.save-container {\n\t\t\t\t\tmargin-top: 8px; /* 调整margin */\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\talign-items: center;\n\t\t\t\t\tgap: 10px; /* 调整gap */\n\t\t\t\t}\n\t\t\t\t.save-btn, .back-btn {\n\t\t\t\t\tpadding: 6px 15px; /* 调整padding */\n\t\t\t\t\tcolor: white;\n\t\t\t\t\tborder: none;\n\t\t\t\t\tborder-radius: 4px;\n\t\t\t\t\tcursor: pointer;\n\t\t\t\t}\n\t\t\t\t.save-btn {\n\t\t\t\t\tbackground: #4CAF50;\n\t\t\t\t}\n\t\t\t\t.save-btn:hover {\n\t\t\t\t\tbackground: #45a049;\n\t\t\t\t}\n\t\t\t\t.back-btn {\n\t\t\t\t\tbackground: #666;\n\t\t\t\t}\n\t\t\t\t.back-btn:hover {\n\t\t\t\t\tbackground: #555;\n\t\t\t\t}\n\t\t\t\t.save-status {\n\t\t\t\t\tcolor: #666;\n\t\t\t\t}\n\t\t\t</style>\n\t\t</head>\n\t\t<body>\n\t\t\t################################################################<br>\n\t\t\t${FileName} 优选订阅列表:<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t<div class="editor-container">\n\t\t\t\t${n?`\n\t\t\t\t<textarea class="editor" \n\t\t\t\t\tplaceholder="${decodeURIComponent(atob("QUREJUU3JUE0JUJBJUU0JUJFJThCJUVGJUJDJTlBCnZpc2EuY24lMjMlRTQlQkMlOTglRTklODAlODklRTUlOUYlOUYlRTUlOTAlOEQKMTI3LjAuMC4xJTNBMTIzNCUyM0NGbmF0CiU1QjI2MDYlM0E0NzAwJTNBJTNBJTVEJTNBMjA1MyUyM0lQdjYKCiVFNiVCMyVBOCVFNiU4NCU4RiVFRiVCQyU5QQolRTYlQUYlOEYlRTglQTElOEMlRTQlQjglODAlRTQlQjglQUElRTUlOUMlQjAlRTUlOUQlODAlRUYlQkMlOEMlRTYlQTAlQkMlRTUlQkMlOEYlRTQlQjglQkElMjAlRTUlOUMlQjAlRTUlOUQlODAlM0ElRTclQUIlQUYlRTUlOEYlQTMlMjMlRTUlQTQlODclRTYlQjMlQTgKSVB2NiVFNSU5QyVCMCVFNSU5RCU4MCVFOSU5QyU4MCVFOCVBNiU4MSVFNyU5NCVBOCVFNCVCOCVBRCVFNiU4QiVBQyVFNSU4RiVCNyVFNiU4QiVBQyVFOCVCNSVCNyVFNiU5RCVBNSVFRiVCQyU4QyVFNSVBNiU4MiVFRiVCQyU5QSU1QjI2MDYlM0E0NzAwJTNBJTNBJTVEJTNBMjA1MwolRTclQUIlQUYlRTUlOEYlQTMlRTQlQjglOEQlRTUlODYlOTklRUYlQkMlOEMlRTklQkIlOTglRTglQUUlQTQlRTQlQjglQkElMjA0NDMlMjAlRTclQUIlQUYlRTUlOEYlQTMlRUYlQkMlOEMlRTUlQTYlODIlRUYlQkMlOUF2aXNhLmNuJTIzJUU0JUJDJTk4JUU5JTgwJTg5JUU1JTlGJTlGJUU1JTkwJThECgoKQUREQVBJJUU3JUE0JUJBJUU0JUJFJThCJUVGJUJDJTlBCmh0dHBzJTNBJTJGJTJGcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSUyRmNtbGl1JTJGV29ya2VyVmxlc3Myc3ViJTJGcmVmcyUyRmhlYWRzJTJGbWFpbiUyRmFkZHJlc3Nlc2FwaS50eHQKCiVFNiVCMyVBOCVFNiU4NCU4RiVFRiVCQyU5QUFEREFQSSVFNyU5QiVCNCVFNiU4RSVBNSVFNiVCNyVCQiVFNSU4QSVBMCVFNyU5QiVCNCVFOSU5MyVCRSVFNSU4RCVCMyVFNSU4RiVBRg=="))}"\n\t\t\t\t\tid="content">${r}</textarea>\n\t\t\t\t<div class="save-container">\n\t\t\t\t\t<button class="back-btn" onclick="goBack()">返回配置页</button>\n\t\t\t\t\t<button class="save-btn" onclick="saveContent()">保存</button>\n\t\t\t\t\t<span class="save-status" id="saveStatus"></span>\n\t\t\t\t</div>\n\t\t\t\t<br>\n\t\t\t\t################################################################<br>\n\t\t\t\t${cmad}\n\t\t\t\t`:"<p>未绑定KV空间</p>"}\n\t\t\t</div>\n\n\t\t\t<script>\n\t\t\tif (document.querySelector('.editor')) {\n\t\t\t\tlet timer;\n\t\t\t\tconst textarea = document.getElementById('content');\n\t\t\t\tconst originalContent = textarea.value;\n\n\t\t\t\tfunction goBack() {\n\t\t\t\t\tconst currentUrl = window.location.href;\n\t\t\t\t\tconst parentUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/'));\n\t\t\t\t\twindow.location.href = parentUrl;\n\t\t\t\t}\n\n\t\t\t\tfunction replaceFullwidthColon() {\n\t\t\t\t\tconst text = textarea.value;\n\t\t\t\t\ttextarea.value = text.replace(/：/g, ':');\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tfunction saveContent() {\n\t\t\t\t\treplaceFullwidthColon();\n\t\t\t\t\tconst newContent = textarea.value;\n\t\t\t\t\tif (newContent !== originalContent) {\n\t\t\t\t\t\tfetch(window.location.href, {\n\t\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\t\tbody: newContent\n\t\t\t\t\t\t}).then(() => {\n\t\t\t\t\t\t\tconst now = new Date().toLocaleString();\n\t\t\t\t\t\t\tdocument.title = \`编辑已保存 \${now}\`;\n\t\t\t\t\t\t\tdocument.getElementById('saveStatus').textContent = \`已保存 \${now}\`;\n\t\t\t\t\t\t}).catch(error => {\n\t\t\t\t\t\t\tdocument.getElementById('saveStatus').textContent = \`保存失败: \${error.message}\`;\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\ttextarea.addEventListener('blur', saveContent);\n\t\t\t\ttextarea.addEventListener('input', () => {\n\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\ttimer = setTimeout(saveContent, 5000);\n\t\t\t\t});\n\t\t\t}\n\t\t\t<\/script>\n\t\t</body>\n\t\t</html>\n\t\t`;return new Response(o,{headers:{"Content-Type":"text/html;charset=utf-8"}})}catch(t){return console.error("处理请求时发生错误:",t),new Response("服务器错误: "+t.message,{status:500,headers:{"Content-Type":"text/plain;charset=utf-8"}})}}
